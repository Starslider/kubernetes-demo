apiVersion: v1
kind: ConfigMap
metadata:
  name: rag-pipeline-code
  namespace: elasticsearch-rag
data:
  rag_pipeline.py: |
    import os
    import json
    import logging
    from flask import Flask, request, jsonify
    from elasticsearch import Elasticsearch
    from sentence_transformers import SentenceTransformer
    import requests
    
    # Configure logging
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    app = Flask(__name__)
    
    # Initialize Elasticsearch client
    es_host = os.getenv('ELASTICSEARCH_HOST', 'elasticsearch')
    es_port = os.getenv('ELASTICSEARCH_PORT', '9200')
    es_index = os.getenv('ELASTICSEARCH_INDEX', 'rag-documents')
    embedding_model_name = os.getenv('EMBEDDING_MODEL', 'all-MiniLM-L6-v2')
    
    es = Elasticsearch([f'http://{es_host}:{es_port}'])
    embedding_model = SentenceTransformer(embedding_model_name)
    
    # Ensure index exists with proper mapping
    def ensure_index():
        if not es.indices.exists(index=es_index):
            mapping = {
                "mappings": {
                    "properties": {
                        "text": {"type": "text"},
                        "metadata": {"type": "object"},
                        "embedding": {
                            "type": "dense_vector",
                            "dims": embedding_model.get_sentence_embedding_dimension()
                        },
                        "timestamp": {"type": "date"}
                    }
                }
            }
            es.indices.create(index=es_index, body=mapping)
            logger.info(f"Created index: {es_index}")
        else:
            logger.info(f"Index {es_index} already exists")
    
    # Initialize on startup
    ensure_index()
    
    @app.route('/health', methods=['GET'])
    def health():
        try:
            es_status = es.ping()
            return jsonify({
                "status": "healthy",
                "elasticsearch": "connected" if es_status else "disconnected"
            }), 200
        except Exception as e:
            return jsonify({
                "status": "unhealthy",
                "error": str(e)
            }), 503
    
    @app.route('/api/v1/index', methods=['POST'])
    def index_document():
        try:
            data = request.json
            if not data or 'text' not in data:
                return jsonify({"error": "Missing 'text' field"}), 400
            
            text = data['text']
            metadata = data.get('metadata', {})
            
            # Generate embedding
            embedding = embedding_model.encode(text).tolist()
            
            # Index document
            doc = {
                "text": text,
                "metadata": metadata,
                "embedding": embedding,
                "timestamp": "now"
            }
            
            result = es.index(index=es_index, document=doc)
            
            return jsonify({
                "success": True,
                "id": result['_id'],
                "index": result['_index']
            }), 201
            
        except Exception as e:
            logger.error(f"Error indexing document: {e}")
            return jsonify({"error": str(e)}), 500
    
    @app.route('/api/v1/search', methods=['POST'])
    def search():
        try:
            data = request.json
            if not data or 'query' not in data:
                return jsonify({"error": "Missing 'query' field"}), 400
            
            query_text = data['query']
            top_k = data.get('top_k', 5)
            
            # Generate query embedding
            query_embedding = embedding_model.encode(query_text).tolist()
            
            # Search using kNN
            search_body = {
                "knn": {
                    "field": "embedding",
                    "query_vector": query_embedding,
                    "k": top_k,
                    "num_candidates": top_k * 10
                },
                "_source": ["text", "metadata", "timestamp"]
            }
            
            results = es.search(index=es_index, body=search_body)
            
            hits = []
            for hit in results['hits']['hits']:
                hits.append({
                    "id": hit['_id'],
                    "score": hit['_score'],
                    "text": hit['_source']['text'],
                    "metadata": hit['_source'].get('metadata', {}),
                    "timestamp": hit['_source'].get('timestamp')
                })
            
            return jsonify({
                "query": query_text,
                "results": hits,
                "total": results['hits']['total']['value']
            }), 200
            
        except Exception as e:
            logger.error(f"Error searching: {e}")
            return jsonify({"error": str(e)}), 500
    
    @app.route('/api/v1/batch-index', methods=['POST'])
    def batch_index():
        try:
            data = request.json
            if not data or 'documents' not in data:
                return jsonify({"error": "Missing 'documents' array"}), 400
            
            documents = data['documents']
            if not isinstance(documents, list):
                return jsonify({"error": "'documents' must be an array"}), 400
            
            success_count = 0
            error_count = 0
            errors = []
            
            for doc in documents:
                try:
                    if 'text' not in doc:
                        errors.append(f"Document missing 'text' field: {doc}")
                        error_count += 1
                        continue
                    
                    text = doc['text']
                    metadata = doc.get('metadata', {})
                    
                    # Generate embedding
                    embedding = embedding_model.encode(text).tolist()
                    
                    # Index document
                    es_doc = {
                        "text": text,
                        "metadata": metadata,
                        "embedding": embedding,
                        "timestamp": "now"
                    }
                    
                    es.index(index=es_index, document=es_doc)
                    success_count += 1
                    
                except Exception as e:
                    error_count += 1
                    errors.append(f"Error indexing document: {str(e)}")
            
            return jsonify({
                "success": True,
                "processed": success_count,
                "failed": error_count,
                "total": len(documents),
                "errors": errors
            }), 200
            
        except Exception as e:
            logger.error(f"Error in batch indexing: {e}")
            return jsonify({"error": str(e)}), 500
    
    @app.route('/api/v1/stats', methods=['GET'])
    def stats():
        try:
            stats = es.indices.stats(index=es_index)
            count = es.count(index=es_index)
            
            return jsonify({
                "index": es_index,
                "document_count": count['count'],
                "index_size": stats['indices'][es_index]['total']['store']['size_in_bytes']
            }), 200
            
        except Exception as e:
            logger.error(f"Error getting stats: {e}")
            return jsonify({"error": str(e)}), 500
    
    if __name__ == '__main__':
        port = int(os.getenv('PORT', 8080))
        app.run(host='0.0.0.0', port=port, debug=False)

