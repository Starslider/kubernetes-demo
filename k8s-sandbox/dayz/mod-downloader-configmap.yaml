---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dayz-mod-downloader
  namespace: dayz
data:
  download-mods.sh: |
    #!/bin/bash
    set -e
    
    echo "=== DayZ Mod Installation Script ==="
    echo "Following official Bohemia documentation"
    
    # Parse MODS env var (semicolon-separated list of IDs)
    if [ -z "$MODS" ]; then
      echo "No mods specified, skipping mod installation"
      exit 0
    fi
    
    # SteamCMD downloads to steamapps/workshop by default
    WORKSHOP_DIR="/home/steam/dayz/steamapps/workshop"
    mkdir -p "$WORKSHOP_DIR"
    
    IFS=';' read -ra MOD_ARRAY <<< "$MODS"
    
    for MOD_ID in "${MOD_ARRAY[@]}"; do
      # Remove @ prefix if present
      MOD_ID_CLEAN="${MOD_ID#@}"
      
      echo ""
      echo "Processing mod: $MOD_ID_CLEAN"
      
      MOD_PATH="$WORKSHOP_DIR/content/221100/$MOD_ID_CLEAN"
      
      # Check if mod already exists
      if [ -d "$MOD_PATH" ]; then
        echo "  Mod already downloaded, skipping..."
      else
        echo "  Downloading from Steam Workshop..."
        
        # Download via SteamCMD to the mounted volume with retry logic for large mods
        # Large mods (13GB+) may need extended time on slower connections
        MAX_RETRIES=5
        RETRY_COUNT=0
        DOWNLOAD_SUCCESS=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$DOWNLOAD_SUCCESS" = false ]; do
          if [ $RETRY_COUNT -gt 0 ]; then
            echo "  Retry attempt $RETRY_COUNT of $MAX_RETRIES..."
            echo "  Waiting 10 seconds before retry..."
            sleep 10
          fi
          
          echo "  Starting download (this may take several minutes for large mods)..."
          
          # Use timeout command with 2 hours (7200 seconds) for very large downloads
          # SteamCMD will handle its own retries, but we wrap it to prevent premature termination
          # Capture exit code properly despite pipe
          set +e  # Temporarily disable exit on error for this section
          timeout 7200 steamcmd \
            +force_install_dir /home/steam/dayz \
            +login "$STEAMACCOUNT" "$STEAMPASSWORD" \
            +workshop_download_item 221100 "$MOD_ID_CLEAN" validate \
            +quit 2>&1 | tee /tmp/steamcmd_output.log
          STEAMCMD_EXIT=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error
          
          # Check if download was successful
          if [ $STEAMCMD_EXIT -eq 0 ]; then
            # Check if download was successful by verifying mod directory exists
            if [ -d "$MOD_PATH" ]; then
              DOWNLOAD_SUCCESS=true
              echo "  ✅ Download completed successfully"
            else
              echo "  ⚠️  SteamCMD completed but mod directory not found"
              echo "  Checking for partial download..."
              # Wait a bit and check again (SteamCMD might still be finalizing)
              sleep 5
              if [ -d "$MOD_PATH" ]; then
                DOWNLOAD_SUCCESS=true
                echo "  ✅ Mod directory found after delay"
              else
                echo "  Retrying download..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
              fi
            fi
          else
            if [ $STEAMCMD_EXIT -eq 124 ]; then
              echo "  ⚠️  Download timed out after 2 hours, retrying..."
            else
              echo "  ⚠️  Download failed with exit code $STEAMCMD_EXIT, retrying..."
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
          fi
        done
        
        if [ "$DOWNLOAD_SUCCESS" = false ]; then
          echo "  ❌ Download failed after $MAX_RETRIES attempts!"
          echo "  Last SteamCMD output:"
          tail -20 /tmp/steamcmd_output.log 2>/dev/null || true
          continue
        fi
      fi
      
      # Create symbolic link in server root WITHOUT @ prefix (official docs)
      # Symlinks must point to the actual path on the mounted volume
      LINK_PATH="/home/steam/dayz/$MOD_ID_CLEAN"
      
      if [ -L "$LINK_PATH" ]; then
        echo "  Symlink already exists"
      else
        echo "  Creating symlink: $LINK_PATH -> $MOD_PATH"
        ln -s "$MOD_PATH" "$LINK_PATH"
      fi
      
      # Copy mod keys to server keys directory BEFORE lowercase conversion
      if [ -d "$MOD_PATH/Keys" ] || [ -d "$MOD_PATH/keys" ]; then
        echo "  Copying mod signing keys..."
        cp -f "$MOD_PATH"/[Kk]eys/*.bikey /home/steam/dayz/keys/ 2>/dev/null || true
      fi
      
      # Copy mission folders to mpmissions directory (required for custom maps)
      # Note: DeerIsle mission folder is handled by a separate init container
      MPMISSIONS_DIR="/home/steam/dayz/mpmissions"
      mkdir -p "$MPMISSIONS_DIR"
      
      # Look for mission folders in the mod directory (for mods that include missions)
      echo "  Searching for mission folders in mod..."
      
      # First, try to find folders with common mission names
      find "$MOD_PATH" -type d \( -name "empty.deerisle" -o -name "dayzOffline.deerisle" -o -name "*.deerisle" \) | while read -r MISSION_DIR; do
        MISSION_NAME=$(basename "$MISSION_DIR")
        TARGET_MISSION="$MPMISSIONS_DIR/$MISSION_NAME"
        if [ ! -d "$TARGET_MISSION" ]; then
          echo "  Found mission folder: $MISSION_NAME"
          echo "  Copying mission folder: $MISSION_NAME -> mpmissions/"
          cp -r "$MISSION_DIR" "$TARGET_MISSION"
        else
          echo "  Mission folder $MISSION_NAME already exists in mpmissions/"
        fi
      done
      
      # Also check for any folders that contain init.c or mission.c files
      find "$MOD_PATH" -type f \( -name "init.c" -o -name "mission.c" \) | while read -r MISSION_FILE; do
        MISSION_DIR=$(dirname "$MISSION_FILE")
        MISSION_NAME=$(basename "$MISSION_DIR")
        # Skip if it's in the root or already copied, and name looks like a mission
        if [ "$MISSION_DIR" != "$MOD_PATH" ] && [ ! -d "$MPMISSIONS_DIR/$MISSION_NAME" ]; then
          # Check if directory name looks like a mission (contains dot or starts with dayzOffline)
          if [[ "$MISSION_NAME" == *.* ]] || [[ "$MISSION_NAME" == dayzOffline* ]]; then
            echo "  Found mission folder by init.c: $MISSION_NAME"
            echo "  Copying mission folder: $MISSION_NAME -> mpmissions/"
            cp -r "$MISSION_DIR" "$MPMISSIONS_DIR/$MISSION_NAME"
          fi
        fi
      done
      
      # Lowercase all files in mod directory (Linux is case-sensitive)
      echo "  Converting filenames to lowercase..."
      find "$MOD_PATH" -depth -exec bash -c 'file="{}"; dir=$(dirname "$file"); base=$(basename "$file"); lower=$(echo "$base" | tr "[:upper:]" "[:lower:]"); [ "$base" != "$lower" ] && mv "$file" "$dir/$lower" 2>/dev/null || true' \;
      
      echo "  ✅ Mod $MOD_ID_CLEAN installed successfully"
    done
    
    # Fix permissions for mission folders (ensure steam user can write storage directories)
    echo ""
    echo "Fixing permissions for mission folders..."
    MPMISSIONS_DIR="/home/steam/dayz/mpmissions"
    if [ -d "$MPMISSIONS_DIR" ]; then
      # Use permissive permissions since chown may not work on all volume types
      find "$MPMISSIONS_DIR" -type d -exec chmod 777 {} \; 2>/dev/null || true
      find "$MPMISSIONS_DIR" -type f -exec chmod 666 {} \; 2>/dev/null || true
      # Ensure empty.deerisle has write permissions for storage
      if [ -d "$MPMISSIONS_DIR/empty.deerisle" ]; then
        chmod -R 777 "$MPMISSIONS_DIR/empty.deerisle" 2>/dev/null || true
        # Create storage directory structure if it doesn't exist
        mkdir -p "$MPMISSIONS_DIR/empty.deerisle/storage_1" 2>/dev/null || true
        chmod 777 "$MPMISSIONS_DIR/empty.deerisle/storage_1" 2>/dev/null || true
        # Also create additional storage directories that might be needed
        for i in {1..10}; do
          mkdir -p "$MPMISSIONS_DIR/empty.deerisle/storage_$i" 2>/dev/null || true
          chmod 777 "$MPMISSIONS_DIR/empty.deerisle/storage_$i" 2>/dev/null || true
        done
      fi
    fi
    
    echo ""
    echo "=== Mod Installation Complete ==="
    echo "Installed mods will be loaded with: -mod=$MODS"
