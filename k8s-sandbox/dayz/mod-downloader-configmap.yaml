---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dayz-mod-downloader
  namespace: dayz
data:
  download-mods.sh: |
    #!/bin/bash
    set -e
    
    echo "=== DayZ Mod Installation Script ==="
    echo "Following official Bohemia documentation"
    
    # Parse MODS env var (semicolon-separated list of IDs)
    if [ -z "$MODS" ]; then
      echo "No mods specified, skipping mod installation"
      exit 0
    fi
    
    # SteamCMD downloads to steamapps/workshop by default
    WORKSHOP_DIR="/home/steam/dayz/steamapps/workshop"
    mkdir -p "$WORKSHOP_DIR"
    
    IFS=';' read -ra MOD_ARRAY <<< "$MODS"
    
    for MOD_ID in "${MOD_ARRAY[@]}"; do
      # Remove @ prefix if present
      MOD_ID_CLEAN="${MOD_ID#@}"
      
      echo ""
      echo "Processing mod: $MOD_ID_CLEAN"
      
      MOD_PATH="$WORKSHOP_DIR/content/221100/$MOD_ID_CLEAN"
      
      # Check if mod already exists
      if [ -d "$MOD_PATH" ]; then
        echo "  Mod already downloaded, skipping..."
      else
        echo "  Downloading from Steam Workshop..."
        
        # Download via SteamCMD to the mounted volume with retry logic for large mods
        # Large mods (13GB+) may need extended time on slower connections
        MAX_RETRIES=5
        RETRY_COUNT=0
        DOWNLOAD_SUCCESS=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$DOWNLOAD_SUCCESS" = false ]; do
          if [ $RETRY_COUNT -gt 0 ]; then
            echo "  Retry attempt $RETRY_COUNT of $MAX_RETRIES..."
            echo "  Waiting 10 seconds before retry..."
            sleep 10
          fi
          
          echo "  Starting download (this may take several minutes for large mods)..."
          
          # Use timeout command with 2 hours (7200 seconds) for very large downloads
          # SteamCMD will handle its own retries, but we wrap it to prevent premature termination
          # Capture exit code properly despite pipe
          set +e  # Temporarily disable exit on error for this section
          timeout 7200 steamcmd \
            +force_install_dir /home/steam/dayz \
            +login "$STEAMACCOUNT" "$STEAMPASSWORD" \
            +workshop_download_item 221100 "$MOD_ID_CLEAN" validate \
            +quit 2>&1 | tee /tmp/steamcmd_output.log
          STEAMCMD_EXIT=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error
          
          # Check if download was successful
          if [ $STEAMCMD_EXIT -eq 0 ]; then
            # Check if download was successful by verifying mod directory exists
            if [ -d "$MOD_PATH" ]; then
              DOWNLOAD_SUCCESS=true
              echo "  ✅ Download completed successfully"
            else
              echo "  ⚠️  SteamCMD completed but mod directory not found"
              echo "  Checking for partial download..."
              # Wait a bit and check again (SteamCMD might still be finalizing)
              sleep 5
              if [ -d "$MOD_PATH" ]; then
                DOWNLOAD_SUCCESS=true
                echo "  ✅ Mod directory found after delay"
              else
                echo "  Retrying download..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
              fi
            fi
          else
            if [ $STEAMCMD_EXIT -eq 124 ]; then
              echo "  ⚠️  Download timed out after 2 hours, retrying..."
            else
              echo "  ⚠️  Download failed with exit code $STEAMCMD_EXIT, retrying..."
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
          fi
        done
        
        if [ "$DOWNLOAD_SUCCESS" = false ]; then
          echo "  ❌ Download failed after $MAX_RETRIES attempts!"
          echo "  Last SteamCMD output:"
          tail -20 /tmp/steamcmd_output.log 2>/dev/null || true
          continue
        fi
      fi
      
      # Create symbolic link in server root WITHOUT @ prefix (official docs)
      # Symlinks must point to the actual path on the mounted volume
      LINK_PATH="/home/steam/dayz/$MOD_ID_CLEAN"
      
      if [ -L "$LINK_PATH" ]; then
        echo "  Symlink already exists"
      else
        echo "  Creating symlink: $LINK_PATH -> $MOD_PATH"
        ln -s "$MOD_PATH" "$LINK_PATH"
      fi
      
      # Copy mod keys to server keys directory BEFORE lowercase conversion
      if [ -d "$MOD_PATH/Keys" ] || [ -d "$MOD_PATH/keys" ]; then
        echo "  Copying mod signing keys..."
        cp -f "$MOD_PATH"/[Kk]eys/*.bikey /home/steam/dayz/keys/ 2>/dev/null || true
      fi
      
      # Copy mission folders to mpmissions directory (required for custom maps)
      MPMISSIONS_DIR="/home/steam/dayz/mpmissions"
      mkdir -p "$MPMISSIONS_DIR"
      
      # Look for mission folders in the mod directory
      # Common mission folder names: empty.deerisle, dayzOffline.deerisle, etc.
      for MISSION_DIR in "$MOD_PATH"/*; do
        if [ -d "$MISSION_DIR" ]; then
          MISSION_NAME=$(basename "$MISSION_DIR")
          # Check if this looks like a mission folder (contains .c files, .pbo files, or init.c)
          if [ -f "$MISSION_DIR/init.c" ] || \
             find "$MISSION_DIR" -maxdepth 2 -type f -name "*.c" | grep -q . || \
             find "$MISSION_DIR" -maxdepth 2 -type f -name "*.pbo" | grep -q .; then
            TARGET_MISSION="$MPMISSIONS_DIR/$MISSION_NAME"
            if [ ! -d "$TARGET_MISSION" ]; then
              echo "  Copying mission folder: $MISSION_NAME -> mpmissions/"
              cp -r "$MISSION_DIR" "$TARGET_MISSION"
            else
              echo "  Mission folder $MISSION_NAME already exists in mpmissions/"
            fi
          fi
        fi
      done
      
      # Lowercase all files in mod directory (Linux is case-sensitive)
      echo "  Converting filenames to lowercase..."
      find "$MOD_PATH" -depth -exec bash -c 'file="{}"; dir=$(dirname "$file"); base=$(basename "$file"); lower=$(echo "$base" | tr "[:upper:]" "[:lower:]"); [ "$base" != "$lower" ] && mv "$file" "$dir/$lower" 2>/dev/null || true' \;
      
      echo "  ✅ Mod $MOD_ID_CLEAN installed successfully"
    done
    
    echo ""
    echo "=== Mod Installation Complete ==="
    echo "Installed mods will be loaded with: -mod=$MODS"
