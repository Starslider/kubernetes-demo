---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dayz
  namespace: dayz
  labels:
    app: dayz
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dayz
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: dayz
    spec:
      volumes:
        - name: ssh-config
          persistentVolumeClaim:
            claimName: ssh-config-pvc
        - name: dayz-data
          persistentVolumeClaim:
            claimName: dayz-data-pvc
        - name: dayz-profile
          persistentVolumeClaim:
            claimName: dayz-profile-pvc
        - name: dayz-server-cfg
          configMap:
            name: dayz-server-cfg
            items:
            - key: serverDZ.cfg
              path: serverDZ.cfg
        - name: dayz-beserver-cfg
          configMap:
            name: dayz-beserver-cfg
            items:
            - key: BEServer_x64.cfg
              path: BEServer_x64.cfg
        - name: mod-downloader-script
          configMap:
            name: dayz-mod-downloader
            defaultMode: 0755
      initContainers:
        - name: mission-downloader
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              apk add --no-cache curl unzip >/dev/null 2>&1
              MPMISSIONS_DIR="/dayz-data/mpmissions"
              mkdir -p "$MPMISSIONS_DIR"
              MISSION_NAME="empty.deerisle"
              TARGET_MISSION="$MPMISSIONS_DIR/$MISSION_NAME"
              
              if [ ! -d "$TARGET_MISSION" ]; then
                echo "Downloading DeerIsle mission folder from GitHub..."
                TEMP_DIR=$(mktemp -d)
                cd "$TEMP_DIR"
                
                # Download the repository as zip
                curl -sL -o deerisle.zip "https://github.com/johnmclane666/Deerisle-6.0-Experimental/archive/refs/heads/main.zip"
                
                # Extract
                unzip -q deerisle.zip
                
                # Copy the mission folder
                if [ -d "Deerisle-6.0-Experimental-main/empty.deerisle" ]; then
                  echo "Copying mission folder to mpmissions..."
                  cp -r "Deerisle-6.0-Experimental-main/empty.deerisle" "$TARGET_MISSION"
                  # Fix permissions - ensure steam user can write (for storage directories)
                  # Note: chown may not work on all volume types, so we also set permissive permissions
                  chown -R 1001:1001 "$TARGET_MISSION" 2>/dev/null || true
                  chmod -R 777 "$TARGET_MISSION" || true
                  # Create storage directory with proper permissions
                  mkdir -p "$TARGET_MISSION/storage_1" || true
                  chmod 777 "$TARGET_MISSION/storage_1" 2>/dev/null || true
                  echo "Mission folder downloaded successfully"
                else
                  echo "Error: Mission folder not found in downloaded archive"
                  ls -la "Deerisle-6.0-Experimental-main/" || true
                  exit 1
                fi
                
                rm -rf "$TEMP_DIR"
              else
                echo "Mission folder $MISSION_NAME already exists, fixing permissions..."
                chown -R 1001:1001 "$TARGET_MISSION" 2>/dev/null || true
                chmod -R 777 "$TARGET_MISSION" || true
                # Ensure storage directory exists with proper permissions
                mkdir -p "$TARGET_MISSION/storage_1" || true
                chmod 777 "$TARGET_MISSION/storage_1" 2>/dev/null || true
              fi
          volumeMounts:
            - name: dayz-data
              mountPath: /dayz-data
        - name: mod-downloader
          image: ghcr.io/starslider/dayz-server:latest
          command: ["/bin/bash", "/scripts/download-mods.sh"]
          volumeMounts:
            - name: dayz-data
              mountPath: /home/steam/dayz
            - name: dayz-data
              mountPath: /home/steam/.steam
              subPath: .steam-cache
            - name: dayz-data
              mountPath: /home/steam/Steam
              subPath: .steamcmd-cache
            - name: dayz-data
              mountPath: /home/steam/.local
              subPath: .local-cache
            - name: mod-downloader-script
              mountPath: /scripts
          env:
            - name: MODS
              value: "1828439124;1750506510;1559212036"
            - name: HOME
              value: /home/steam
            - name: STEAMACCOUNT
              valueFrom:
                secretKeyRef:
                  name: steamaccount
                  key: STEAMACCOUNT
            - name: STEAMPASSWORD
              valueFrom:
                secretKeyRef:
                  name: steamaccount
                  key: STEAMPASSWORD
      containers:
        - name: dayz
          image: ghcr.io/starslider/dayz-server:latest
          imagePullPolicy: Always
          volumeMounts:
          - mountPath: "/home/steam/dayz"
            name: dayz-data
          - mountPath: "/home/steam/.steam"
            name: dayz-data
            subPath: .steam-cache
          - mountPath: "/home/steam/Steam"
            name: dayz-data
            subPath: .steamcmd-cache
          - mountPath: "/home/steam/.local"
            name: dayz-data
            subPath: .local-cache
          - mountPath: "/home/steam/profile"
            name: dayz-profile
          - name: dayz-server-cfg
            mountPath: "/home/steam/serverDZ.cfg"
            subPath: serverDZ.cfg
          - name: dayz-beserver-cfg
            mountPath: "/home/steam/battleye/BEServer_x64.cfg"
            subPath: BEServer_x64.cfg
          env:
            - name: GAME
              value: dayz
            - name: HOME
              value: /home/steam
            - name: APPID
              value: "223350"
            - name: STEAMACCOUNT
              valueFrom:
                secretKeyRef:
                  name: steamaccount
                  key: STEAMACCOUNT
            - name: STEAMPASSWORD
              valueFrom:
                secretKeyRef:
                  name: steamaccount
                  key: STEAMPASSWORD
            - name: STEAM_LOGIN_TOKEN
              valueFrom:
                secretKeyRef:
                  name: steamaccount
                  key: STEAM_LOGIN_TOKEN
            - name: CPUCOUNT
              value: "4"
            - name: PORT
              value: "2302"
            - name: MODS
              value: "1828439124;1750506510;1559212036"
        - name: openssh-server
          image: lscr.io/linuxserver/openssh-server:latest
          imagePullPolicy: Always
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "America/New_York"
            - name: SUDO_ACCESS
              value: "false"
            - name: PASSWORD_ACCESS
              value: "true"
            - name: USER_NAME
              valueFrom:
                secretKeyRef:
                  name: ssh-sec
                  key: USER_NAME
            - name: USER_PASSWORD
              valueFrom: 
                secretKeyRef:
                  name: ssh-sec
                  key: USER_PASSWORD
          volumeMounts:
          - mountPath: "/config"
            name: ssh-config
          - mountPath: "/home/steam/dayz"
            name: dayz-data
          - mountPath: "/home/steam/profile"
            name: dayz-profile
          ports:
            - name: ssh
              containerPort: 2222
            - name: rcon
              containerPort: 2310
            - name: steam-27016
              containerPort: 27016
            - name: steam-8766
              containerPort: 8766
            - name: game-2305
              containerPort: 2305
            - name: game-2304
              containerPort: 2304
            - name: game-2303
              containerPort: 2303
            - name: game-2302
              containerPort: 2302

