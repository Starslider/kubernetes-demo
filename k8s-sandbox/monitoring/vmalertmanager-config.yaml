apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAlertmanagerConfig
metadata:
  name: discord-alerts
  namespace: monitoring
spec:
  route:
    group_by: ['alertname', 'cluster', 'service']
    group_wait: 10s
    group_interval: 10s
    repeat_interval: 1h
    receiver: 'discord-webhook'
    routes:
    - matchers:
      - "alertname=Watchdog"
      receiver: 'null'
      group_wait: 10s
      repeat_interval: 1h
    # Suppress TargetDown alerts for control-plane components with TLS cert issues
    - matchers:
      - "alertname=TargetDown"
      - "job=~kube-scheduler|kube-controller-manager"
      receiver: 'null'
      group_wait: 10s
      repeat_interval: 24h
    - matchers:
      - "severity=critical"
      receiver: 'discord-critical'
      group_wait: 10s
      repeat_interval: 5m
    - matchers:
      - "severity=warning"
      receiver: 'discord-warning'
      group_wait: 30s
      repeat_interval: 15m
  receivers:
  - name: 'discord-webhook'
    discord_configs:
    - webhook_url_secret:
        name: discord-webhook-secret
        key: webhook-url
      send_resolved: true
      username: 'AlertManager'
      avatar_url: 'https://avatars.githubusercontent.com/u/3380462'
      title: 'üö® Kubernetes Alert'
      message: |
        **Alert:** {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
        **Status:** {{ .Status | toUpper }}
        **Severity:** {{ with .CommonLabels.severity }}{{ . | toUpper }}{{ else }}UNKNOWN{{ end }}
        **Cluster:** {{ with .CommonLabels.cluster }}{{ . }}{{ else }}kubernetes{{ end }}
        
        {{ range .Alerts }}**Description:** {{ .Annotations.description }}
        **Started:** <t:{{ .StartsAt.Unix }}:R>
        {{ if ne .Status "resolved" }}{{ else }}**Resolved:** <t:{{ .EndsAt.Unix }}:R>{{ end }}
        {{ end }}
  - name: 'discord-critical'
    discord_configs:
    - webhook_url_secret:
        name: discord-webhook-secret
        key: webhook-url
      send_resolved: true
      username: 'AlertManager - CRITICAL'
      avatar_url: 'https://avatars.githubusercontent.com/u/3380462'
      title: 'üî• CRITICAL KUBERNETES ALERT üî•'
      message: |
        @here **CRITICAL ALERT TRIGGERED!**
        
        **Alert:** {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
        **Status:** {{ .Status | toUpper }}
        **Severity:** CRITICAL
        **Cluster:** {{ with .CommonLabels.cluster }}{{ . }}{{ else }}kubernetes{{ end }}
        
        {{ range .Alerts }}**Description:** {{ .Annotations.description }}
        **Started:** <t:{{ .StartsAt.Unix }}:R>
        {{ if ne .Status "resolved" }}{{ else }}**Resolved:** <t:{{ .EndsAt.Unix }}:R>{{ end }}
        
        **Labels:**
        {{ range .Labels.SortedPairs }}- {{ .Name }}: `{{ .Value }}`
        {{ end }}
        {{ end }}
  - name: 'discord-warning'
    discord_configs:
    - webhook_url_secret:
        name: discord-webhook-secret
        key: webhook-url
      send_resolved: true
      username: 'AlertManager - Warning'
      avatar_url: 'https://avatars.githubusercontent.com/u/3380462'
      title: '‚ö†Ô∏è Kubernetes Warning'
      message: |
        **Alert:** {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
        **Status:** {{ .Status | toUpper }}
        **Severity:** WARNING
        **Cluster:** {{ with .CommonLabels.cluster }}{{ . }}{{ else }}kubernetes{{ end }}
        
        {{ range .Alerts }}**Description:** {{ .Annotations.description }}
        {{ if ne .Status "resolved" }}{{ else }}**Resolved:** <t:{{ .EndsAt.Unix }}:R>{{ end }}
        {{ end }}
  - name: 'null'
