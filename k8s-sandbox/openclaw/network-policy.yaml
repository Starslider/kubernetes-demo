apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: openclaw-policy
  namespace: openclaw
spec:
  endpointSelector:
    matchLabels:
      app: openclaw
  ingress:
  # Allow traffic from ingress namespace (Gateway / oauth2-proxy)
  - fromEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: ingress
  # Allow intra-namespace traffic (oauth2-proxy sidecar)
  - fromEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: openclaw
  egress:
  # DNS resolution via kube-dns
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s:k8s-app: kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  # xAI Grok API (104.18.18.0/23 covers Cloudflare range for api.x.ai)
  - toCIDRSet:
    - cidr: 104.18.18.0/23
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # Telegram Bot API (149.154.160.0/20 covers Telegram's DC range)
  - toCIDRSet:
    - cidr: 149.154.160.0/20
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # Authentik OIDC (local network for oauth2-proxy token validation)
  - toCIDRSet:
    - cidr: 192.168.1.210/32
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # Home Assistant (LAN - http://192.168.1.10:8123)
  - toCIDRSet:
    - cidr: 192.168.1.10/32
    toPorts:
    - ports:
      - port: "8123"
        protocol: TCP
  # Ring API - oauth.ring.com (Cloudflare)
  # WARNING: Ring uses AWS infrastructure with rotating IPs. These CIDRs may
  # need updating if Ring changes providers or IP allocations.
  - toCIDRSet:
    - cidr: 104.17.0.0/16
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # Ring API - api.ring.com, app.ring.com, fw.ring.com (AWS us-east-1)
  - toCIDRSet:
    - cidr: 13.217.0.0/16
    - cidr: 35.168.0.0/13
    - cidr: 44.209.0.0/16
    - cidr: 52.71.0.0/16
    - cidr: 52.200.0.0/16
    - cidr: 54.164.0.0/16
    - cidr: 54.237.0.0/16
    - cidr: 98.91.0.0/16
    - cidr: 98.95.0.0/16
    - cidr: 100.50.0.0/16
    - cidr: 107.20.0.0/16
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # Brave Search API (AWS Global Accelerator - static anycast)
  - toCIDRSet:
    - cidr: 15.197.138.111/32
    - cidr: 3.33.153.106/32
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # Simmer Prediction Markets API (Railway - api.simmer.markets)
  - toCIDRSet:
    - cidr: 66.33.22.0/23
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # ClawHub skill marketplace (Vercel - clawhub.ai)
  - toCIDRSet:
    - cidr: 216.150.1.0/24
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
  # npm registry (Cloudflare - registry.npmjs.org)
  - toCIDRSet:
    - cidr: 104.16.0.0/20
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
